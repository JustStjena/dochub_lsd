contexts:
  L1:
    title: Автогенерация  L1
    location: L1
    components:
      # Выбираем все компоненты на первом уровне
      - "*"
    # Готовим данные для контекста
    source: >
      (
        /* Определяем шаблон для идентификаторов */
        $isl2 := /^([^\.]*)(\.([^\.]*))?$/;
        /* Генерируем список компонентов L1 ровня */
        $result := $mergedeep($.components.$spread().(
          $id := $keys()[0];
          $node := $.*;
          $levels := $isl2($id).groups;
          /* Формируем ноду */
          $node :=
            /* Если это компонент уровня L2 */
            $levels[2]
            /* Создаем виртуальный компонент L1 с информацией о связях */
            ? $merge([
              {
                $levels[0]: {
                  "links":
                    $distinct($node.links.{
                      /* Преобразуем идентификатор связи к L1 */
                      "id": $split(id, ".")[0],
                      "title":  title,
                      "direction": "--"
                    })[id != $levels[0]]
                }
              }
            ])
            /* Иначе, преобразуем связи компонента к уровню L1 */
            : $merge([
              {
                $id: $merge([$.*, {
                  "links":
                    $distinct($node.links.{
                      /* Преобразуем идентификатор связи к L1 */
                      "id": $split(id, ".")[0],
                      "title":  title,
                      "direction": "--"
                    })[id != $levels[0]]
                }])
              }
            ])
        ));
        /* Перезаписываем данные манифеста новыми компонентами */
        $merge([$,
          { "components": $result}
        ]);        
      )